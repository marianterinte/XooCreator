<section class="builder" aria-labelledby="page-title">
  <!-- A. Header -->
  <header class="page-header">
    <button class="btn-icon back" type="button" aria-label="Înapoi" (click)="openExitConfirm()">←</button>
    <div class="spacer"></div>
    <button class="btn-icon help" type="button" aria-label="Ajutor" (click)="openHelp()">?</button>
  </header>

  <!-- B. Panou Sus — Body Parts: carousel (thumbnails) + big image -->
  <section class="panel panel-top" aria-labelledby="bp-section-title">
  <div class="carousel thumbs" role="listbox" aria-label="Body parts">
      <button
        *ngFor="let p of parts; let i = index"
    class="thumb" [class.active]="i === activePartIdx()" [class.locked]="isPartLocked(p.key)"
    type="button" role="option" [attr.aria-selected]="i === activePartIdx()"
    (click)="selectPart(i)"
    [disabled]="false">
    <img [src]="p.image" [alt]="p.name" />
    <span *ngIf="isPartLocked(p.key)" class="badge-lock" aria-hidden="true">🔒</span>
      </button>
    </div>

    <figure class="preview" [class.locked]="isPartLocked(currentPart().key)"
      (pointerdown)="onTopPointerDown($event)"
      (pointermove)="onTopPointerMove($event)"
      (pointerup)="onTopPointerUp($event)"
      (pointercancel)="onTopPointerCancel($event)"
      [style.transform]="topDragX() ? 'translateX(' + topDragX() + 'px)' : ''"
      [class.dragging]="topDragging()">
  <img data-testid="bp-image" [src]="currentPart().image" [alt]="currentPart().name + ' preview'" />
      <div class="lock-overlay" *ngIf="isPartLocked(currentPart().key)" aria-hidden="true">🔒</div>
      <figcaption class="preview-caption" data-testid="bp-label">{{ currentPart().name }}</figcaption>
    </figure>
  </section>

  <!-- C. Panou Jos — Animals: big image + carousel (thumbnails) -->
  <section class="panel panel-bottom" aria-labelledby="sp-section-title">
    <figure class="preview" [class.locked]="isAnimalLocked(activeAnimalIdx())"
      (pointerdown)="onBottomPointerDown($event)"
      (pointermove)="onBottomPointerMove($event)"
      (pointerup)="onBottomPointerUp($event)"
      (pointercancel)="onBottomPointerCancel($event)"
      [style.transform]="bottomDragX() ? 'translateX(' + bottomDragX() + 'px)' : ''"
      [class.dragging]="bottomDragging()">
      <img data-testid="animal-image" [src]="currentAnimal().src" [alt]="currentAnimal().label + ' image'" />
      <div class="lock-overlay" *ngIf="isAnimalLocked(activeAnimalIdx())" aria-hidden="true">🔒</div>
      <figcaption class="preview-caption" data-testid="animal-label">{{ currentAnimal().label }}</figcaption>
    </figure>

  <div class="carousel thumbs" role="listbox" aria-label="Animals">
      <button
        *ngFor="let a of animals; let i = index"
        class="thumb" [class.active]="i === activeAnimalIdx()" [class.locked]="isAnimalLocked(i)"
        type="button" role="option" [attr.aria-selected]="i === activeAnimalIdx()"
        (click)="selectAnimal(i)"
        [disabled]="false">
        <img [src]="a.src" [alt]="a.label" />
        <span *ngIf="isAnimalLocked(i)" class="badge-lock" aria-hidden="true">🔒</span>
      </button>
    </div>
  </section>

  <!-- D. Acțiune jos — Generate -->
  <div class="action-bar">
    <button *ngIf="!isCurrentLocked()" type="button" class="btn-generate" data-testid="btn-generate" aria-label="Generate creature" (click)="confirmGenerate()">Generate</button>
    <button *ngIf="isCurrentLocked()" type="button" class="btn-unlock" data-testid="btn-unlock" aria-label="Unlock" (click)="goToUnlock()">Unlock</button>
  </div>

  <!-- Confirmation Modal -->
  <dialog class="confirm-modal compact" [open]="showConfirm()" aria-labelledby="confirm-title" aria-modal="true">
    <h3 id="confirm-title">Ai ales această configurație. Generăm?</h3>
    <div class="summary">
      <ul>
        <li *ngFor="let p of parts">
          <strong>{{ p.name }}:</strong>
          {{ animals[assignments()[p.key]].label }}
        </li>
      </ul>
    </div>
    <div class="actions">
      <button type="button" class="btn secondary" (click)="cancelGenerate()">Renunță</button>
      <button type="button" class="btn primary" (click)="proceedGenerate()">Generează</button>
    </div>
  </dialog>

  <!-- Exit Confirmation Modal -->
  <dialog class="confirm-modal compact" [open]="showExitConfirm()" aria-labelledby="exit-title" aria-modal="true">
    <h3 id="exit-title">Renunți la modificări?</h3>
    <p style="margin:8px 0 0 0;color:#444">Schimbările curente nu vor fi păstrate.</p>
    <div class="actions">
      <button type="button" class="btn secondary" (click)="cancelExit()">Rămân</button>
      <button type="button" class="btn primary" (click)="proceedExit()">Da, ieși</button>
    </div>
  </dialog>

  <!-- Help / Tutorial Modal -->
  <dialog class="confirm-modal tutorial" [open]="showHelp()" aria-labelledby="help-title" aria-modal="true">
    <h3 id="help-title">Cum funcționează</h3>
    <div class="summary">
      <ol>
        <li>În caruselul de sus alegi partea corpului (cap, corp, brațe, picioare, coadă). Swipe stânga/dreapta sau apasă pe iconițe.</li>
        <li>În imaginea de jos alegi animalul asociat acelei părți. Poți schimba cu swipe stânga/dreapta sau din caruselul de jos.</li>
        <li>Apasă „Generate” pentru a confirma combinația selectată pentru toate părțile.</li>
        <li>Unele părți/animale sunt „locked”. Când alegi o opțiune blocată, butonul devine „Unlock” și te duce la pagina unde poți cumpăra credite.</li>
      </ol>
    </div>
    <div class="actions">
      <button type="button" class="btn primary" (click)="closeHelp()">Înțeles</button>
    </div>
  </dialog>
</section>
