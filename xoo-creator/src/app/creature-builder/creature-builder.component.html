<section class="builder" aria-labelledby="page-title">
  <!-- A. Header -->
  <header class="page-header">
    <button class="btn-icon back" type="button" aria-label="Înapoi" (click)="openExitConfirm()">←</button>
    <div class="spacer"></div>
    <div class="credits">{{ creditsLeft }} credits</div>
    <div class="spacer"></div>
    <button class="btn-icon help" type="button" aria-label="Ajutor" (click)="openHelp()">?</button>
  </header>

  <!-- B. Panou Sus — Body Parts: carousel (thumbnails) + big image -->
  <section class="panel panel-top" aria-labelledby="bp-section-title">
  <div class="carousel thumbs" role="listbox" aria-label="Body parts">
      @for (p of parts; let i = $index; track $index) {
      <button
    class="thumb" [class.active]="i === activePartIdx()" [class.locked]="isPartLocked(p.key)"
    type="button" role="option" [attr.aria-selected]="i === activePartIdx()"
    (click)="selectPart(i)"
    [disabled]="false">
    <img [src]="p.image" [alt]="p.name" />
    <span *ngIf="isPartLocked(p.key)" class="badge-lock" aria-hidden="true">🔒</span>
      </button>
      }
    </div>

    <figure class="preview" [class.locked]="isPartLocked(currentPart().key)"
      appSwipeX #topSwipe="swipeX" [threshold]="60"
      (swipeLeft)="nextPart()" (swipeRight)="prevPart()"
      [style.transform]="topSwipe.dragX ? 'translateX(' + topSwipe.dragX + 'px)' : ''"
      [class.dragging]="topSwipe.dragging">
  <img data-testid="bp-image" [src]="currentPart().image" [alt]="currentPart().name + ' preview'" />
      <div class="lock-overlay" *ngIf="isPartLocked(currentPart().key)" aria-hidden="true">🔒</div>
      <figcaption class="preview-caption" data-testid="bp-label">{{ currentPart().name }}</figcaption>
    </figure>
  </section>

  <!-- C. Panou Jos — Animals: big image + carousel (thumbnails) -->
  <section class="panel panel-bottom" aria-labelledby="sp-section-title">
    <figure class="preview" [class.locked]="isAnimalLocked(activeAnimalIdx())"
      appSwipeX #bottomSwipe="swipeX" [threshold]="60"
      (swipeLeft)="nextAnimal()" (swipeRight)="prevAnimal()"
      [style.transform]="bottomSwipe.dragX ? 'translateX(' + bottomSwipe.dragX + 'px)' : ''"
      [class.dragging]="bottomSwipe.dragging">
      <img data-testid="animal-image" [src]="currentAnimal().src" [alt]="currentAnimal().label + ' image'" />
      <div class="lock-overlay" *ngIf="isAnimalLocked(activeAnimalIdx())" aria-hidden="true">🔒</div>
      <figcaption class="preview-caption" data-testid="animal-label">{{ currentAnimal().label }}</figcaption>
    </figure>

  <div class="carousel thumbs" role="listbox" aria-label="Animals">
      @for (a of animalsForCurrentPart(); let i = $index; track $index) {
      <button
        class="thumb" [class.active]="isActiveAnimal(a)" [class.locked]="isAnimalLocked(getGlobalIndex(a))"
        type="button" role="option" [attr.aria-selected]="isActiveAnimal(a)"
        (click)="selectAnimal(i)"
        [disabled]="false">
        <img [src]="a.src" [alt]="a.label" />
        <span *ngIf="isAnimalLocked(getGlobalIndex(a))" class="badge-lock" aria-hidden="true">🔒</span>
      </button>
      }
    </div>
  </section>

  <!-- D. Acțiune jos — Generate -->
  <div class="action-bar">
    <button *ngIf="!isCurrentLocked()" type="button" class="btn-generate" data-testid="btn-generate" aria-label="Generate creature" (click)="confirmGenerate()">Generate</button>
    <button *ngIf="isCurrentLocked()" type="button" class="btn-unlock" data-testid="btn-unlock" aria-label="Unlock" (click)="goToUnlock()">Unlock</button>
  </div>

  <!-- Confirmation Modal (standalone) -->
  <confirm-generate-modal
    [open]="showConfirm()"
    [parts]="parts"
    [animals]="animals"
    [assignments]="assignments()"
    [selection]="generateSelection()"
    [disabledMap]="generateDisabledMap()"
    [generateCost]="generateCost"
    [creditsLeft]="creditsLeft"
    (cancel)="cancelGenerate()"
    (unlock)="goToUnlock()"
    (proceed)="proceedGenerate()"
    (toggle)="toggleGeneratePart($event)"
  />

  <!-- Exit Confirmation Modal -->
  <dialog class="confirm-modal compact" [open]="showExitConfirm()" aria-labelledby="exit-title" aria-modal="true">
    <h3 id="exit-title">Renunți la modificări?</h3>
    <p style="margin:8px 0 0 0;color:#444">Schimbările curente nu vor fi păstrate.</p>
    <div class="actions">
      <button type="button" class="btn secondary" (click)="cancelExit()">Rămân</button>
      <button type="button" class="btn primary" (click)="proceedExit()">Da, ieși</button>
    </div>
  </dialog>

  <!-- Help / Tutorial Modal (standalone) -->
  <help-modal [open]="showHelp()" (close)="closeHelp()" />

  <!-- Result / Generation Modal (standalone) -->
  <result-modal
    [open]="showResult()"
    [inProgress]="genInProgress()"
    [progress]="genProgress()"
    [message]="genMessage()"
    [image]="resultImage()"
    [name]="resultName()"
    [story]="resultStory()"
    [flipped]="resultFlipped()"
    (close)="showResult.set(false)"
    (flip)="flipResultCard()"
  />
</section>
